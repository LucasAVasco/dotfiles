#!/bin/bash
#
# Command to preview files (supports images) and folders.
#
# Has integration with Kitty and WezTerm to show images.
#
# Can be used as a preview script for fzf (also support previewing images in fzf).
#
# $1: file to preview.

file="$1"

# If the file does not exist
if [[ ! -e "$file" ]]; then
	echo "'$file' does not exist"
	exit 0
fi

# If it is a directory
if [[ -d "$file" ]]; then
	# '--git' shows the git status
	eza -A --icons=always --color=always --git
	exit 0
fi

# If the file is not a image (like a text file)
if ! file --mime-type "$file" | grep -q image/; then
	bat --color=always "$file"
	exit 0
fi

# If the file is an image {{{

# Gets image dimensions
width=${FZF_PREVIEW_COLUMNS:-$(tput cols)}
height=${FZF_PREVIEW_LINES:-$(tput lines)}
left=${FZF_PREVIEW_LEFT:-0}
top=${FZF_PREVIEW_TOP:-0}

# Kitty terminal emulator
if [[ -n "$KITTY_PID" ]]; then
	# '--clear' removes the other images
	# '--transfer-mode=stream' sends the image directly to the terminal
	# '--stdin=no' prevents the image path from being copied from the input (the '--place' option only works with one image)
	# '--place' puts the image in the correct position
	# NOTE(): `chafa` can not be used because it does not support the '--clear' option
	kitty icat --clear --transfer-mode=stream --stdin=no --place=${width}x${height}@${left}x${top} "$file"
fi

# WezTerm terminal emulator
if [[ -n "$WEZTERM_UNIX_SOCKET" ]]; then
	# NOTE(): I could not find a way to use `wezterm imgcat`, so I used `chafa`
	chafa -f iterm -s "$width"x"$height" "$file"
fi

# }}}
